# Инфологическое проектирование
**Анализ предметной области** </br>
БД должна содержать данные о сделках, платежах, пользователях, ролях, расчетах, отчетах, курсах валют.</br>
Для создания ER-модели необходимо выделить сущности предметной области и указать их атрибуты:
- Сделки: id, дата создания, дата погашения, типология сделки, тип опциона, id контракта, платежный тип, продукт, стоимость, портфель, наименование представления.
- Платежи: id, дата создания, дата погашения, типология сделки, тип опциона, id контракта, платежный тип, продукт, наименование потока, стоимость, валюта.
- Курсы: id, дата, валюта, значение
- Расчеты: id расчета, дата расчета, время запуска, время завершения, id пользователя, id платежа, статус, наименование потока.
- Отчеты: id отчета, время запуска, время завершения, id пользователя, наименование, статус.
- Пользователи: id, ФИО, роль, логин, почта.
- Роли: id, название, совместимость, права.
- Права: id, наименование права, назначение.
- Аудит: id, время события, наименование события, пользователь.


![ER–диаграмма «Система расчета ликвидности»](https://github.com/user-attachments/assets/db964de2-4a62-4bb6-a08b-17835ecbe9c1)</br>
**ER–диаграмма «Система расчета ликвидности»** </br>


**Анализ информационных задач и круга пользователей системы**</br>
Определим группы пользователей, их основные задачи и запросы к БД:</br>

***Администратор системы:***
- выдача прав;
- редактирование информации о пользователях
- прсомтр аудита;
- просмотр расчетов, отчетов;

***Бизнес-пользователь:***
- просмотр и запуск расчетов
- запуск и скачивание отчетов
  
***Аудитор:***
- скачивание отчета;
- просмотр результатов расчета

# Выбор СУБД и других программных средств
Ввиду широкой разновидности типов платежей, в каждом из которых есть свои параметры, а также частом расширении загружаемых атрибутов, было принято решение использовать NoSQL базу данных документо-ориентированного типа. Таким образом физическое проектирование будет выполнено с использованием СУБД Mongodb версии 5.0.6.

# Логическое проектирование БД
Преобразование ER–диаграммы в схему БД выполняется путем сопоставления каждой сущности и каждой связи. В Mongodb есть два способа связывания таблиц: встроенные документы и ссылки.

![image](https://github.com/user-attachments/assets/9d476a54-58ce-4af4-9781-09973ead2bc5)
**Полученная схема нереляционной базы данных (НРБД)**

<details>


**<summary>Структура коллекций</summary>**

Таблица 1. Схема отношения Сделки (trades)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Дата|valueDate|Timestamp|обязательное поле,<br/> в составе индекса, <br/> используется в дедупликации
|Стоимость|value|Double|обязательное поле
|Тип метрики|metricType|String|обязательное поле, <br/> в составе индекса, <br/>
|Источник|source|String|обязательное поле, <br/> в составе индекса
|Название представления|view|String|обязательное поле
|Инструмент|instrument|String|обязательное поле,<br/> (пример: USD/RUB)
|Портфель|portfolio|String|обязательное поле
|Номер контракта|contractNumber|Integer|обязательное поле
|Дата погашения|maturityDate|Date|обязательное поле
|Номер сделки|tradeNumber|Integer|обязательное поле
|Тип сделки|tradeType|String|обязательное поле
|Дата заключения сделки|tradeDate|Date|обязательное поле
|Валюта|currency|String|обязательное поле|

Таблица 2. Схема отношения Курсы (rates)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Дата|valueDate|Timestamp|обязательное поле,<br/> дедупликация по дате
|Курс|value|Double|обязательное поле
|Валюта|currency|String|обязательное поле
|Валютная пара|currencyRate|String|обязательное поле
|Время загрузки|dateTime|Timestamp|обязательное поле|

Таблица 3.Схема отношения Статистика расчетов (calculationStatistics)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Наименование расчета|calculatorName|String|обязательное поле,<br/> дедупликация по дате
|Пользователь запустил расчет|userName|String|обязательное поле,<br/> ***ссылка на коллекцию users***
|Дата создания|createDate|Timestamp|обязательное поле
|Дата расчета|generateDate|Date|обязательное поле
|Наименование потока|dataFlow|String|обязательное поле
|Статус расчета|status|String|обязательное поле|

Таблица 4. Схема отношения Платежи (payments)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Дата|valueDate|Timestamp|обязательное поле,<br/> в составе индекса, <br/> используется в дедупликации
|Стоимость|value|Double|обязательное поле
|Тип метрики|flow|String|обязательное поле, <br/> в составе индекса, <br/> используется в дедупликации
|Инструмент|instrument|String|обязательное поле
|Портфель|portfolio|String|обязательное поле
|***Курс валюты***|***currencyRate*** <br/> currencyRate.currency <br/> currencyRate.value|***Array*** <br/> String <br/> Double |***Вложенный документ из коллекции rates***
|Номер контракта|contractNumber|Integer|обязательное поле
|Дата погашения|maturityDate|Date|обязательное поле
|Номер сделки|tradeNumber|Integer|обязательное поле
|Тип сделки|tradeType|String|обязательное поле <br/> (internal/external)
|Дата заключения сделки|tradeDate|Date|обязательное поле
|Тип транзакции|transactionType|String|обязательное поле <br/> (call/put)
|Опцион на покупку/продажу|buysell|String|обязательное поле
|Организация|legalEntity|String|обязательное поле
|Тип опциона|optionType|String|обязательное поле <br/> (american,european)
|Тип платежа|paymentType|String|обязательное поле <br/> (Forecast, Premium)
|Дата погашения|paymentDate|Date|обязательное поле
|***Данные по расчету***|***calculationData*** <br/> calculationData._id <br/> calculationData.name|***Array*** <br/> ObjectId <br/> String |***Вложенный документ из коллекции calculationStatistics***|

Таблица 5. Схема отношения Отчеты (reportsTasks) 
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Наименование отчета|reportName|String|обязательное поле
|Идентификатор шаблона|template_id|ObjectId|обязательное поле, <br/> ***ссылка на коллекцию templates***
|Отчетная дата|reportDate|Date|обязательное поле
|Наименование потока|flow|String|обязательное поле
|***Имя файла***|***file*** <br/> file._id <br/> file.filename |***Array*** <br/> ObjectId <br/> String|***Вложенный документ из коллекции reports_files.files***
|Формат файла|format|String|обязательное поле
|Дата создания|generateDate|Timestamp|обязательное поле
|Имя пользователя|creator|String|обязательное поле, <br/> ***ссылка на коллекцию users***
|Статус отчета|reportStatus|String|обязательное поле|

Таблица 6. Схема отношения Шаблоны (templates)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Наименование шаблона|templateName|String|обязательное поле, <br/> ***уникальное поле***
|Дата создания|createDate|Timestamp|обязательное поле
|Имя пользователя|creator|String|обязательное поле
|Файл |body|Binary Data|обязательное поле|

Таблица 7. Схема отношения Файлы отчетов (reports_files.files)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Имя файла|filename|String|обязательное поле
|Длина|length|Integer|обязательное поле
|Дата обновления|uploadDate|Timestamp|обязательное поле
|Размер чанка|chunkSize|Integer|обязательное поле
|Хеш|md5|String|обязательное поле|

Таблица 8. Схема отношения Части файлов отчетов (reports_files.chunks)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Идентификатор файла|file_id|ObjectId|обязательное поле
|Содержимое|data|Binary Data|обязательное поле|

Таблица 9. Схема отношения Пользователи (users)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Логин|login|String|обязательное поле, <br/> ***уникальное поле***
|ФИО|email|String|обязательное поле, <br/> ***уникальное поле***
|Почта|uploadDate|String|обязательное поле
|Статус|isFired|Boolean|обязательное поле
|Дата изменения|createDate|Timestamp|обязательное поле
|***Роль***|***role*** <br/> role.name <br/> role.permissions|Boolean <br/> String  <br/>String|***Вложенный документ из коллекции roles***|

Таблица 10. Схема отношения Роли (roles)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|Наименование|name|String|обязательное поле
|Права|permissions|Array|обязательное поле|

Таблица 11. Схема отношения Аудит (audit)
  |Содержание поля|Имя поля|Тип|Примечания|
|-|--------|----|---------------|
|Идентификатор|_id|ObjectId|**первичный ключ**
|ФИО|userName|String|обязательное поле <br/>  ***ссылка на коллекцию users***
|Дата события|dateTime|Timestamp|обязательное поле
|Тип события|dateTime|String|обязательное поле
|Описание|description|String| |

</details>


# Индексы
Ввиду большого объема данных для повышения эффективности работы с данными в коллекциях trades и payments необходимо создать следующие Partial indexes: <br/>
- <u>Коллекция trades</u>: составной индекс на поля: valueDate, metricType, source.
- <u>Коллекция payments</u>: составной индекс на поля: valueDate, flow.

# Дедупликация
На уровне ППО должен быть разработан механизм дедупликации для коллекций trades, payments, rates.<br/>
- <u>Trades</u>: при повторной загрузке данных за 1 дату, должны быть удалены старые метрики по valueDate и metricType и добавлены новые.
- <u>Payments</u>: при повторном расчете за одну и ту же дату, должны быть удалены старые метрики по valueDate и flow и добавлены новые.
- <u>Rates</u>: при перезагрузке курсов валют, данные за дату valueDate удаляются перед записью новых значений.


# Хранение файлов в БД
В реализуемой БД будут храниться файлы шаблонов отчетов и самих отчетов. <br/>
Так как файлы шаблонов имеют размер <16Мб, то хранение будет производиться непосредственно в поле body коллекции templates в формате Binary Data.<br/>
Для реализации хранения файлов отчетов будет использоваться спецификация хранения файлов большого объема – ***GridFS***. Для этого созданы отдельные коллекции reports_files.chunks и reports_files.files. Данный подход позволяет хранить файл частями (chunks). Также в коллекции reports_files.files хранится хеш в поле md5, который можно использовать на этапе сравнения файлов.<br/>
GridFS разбивает большие файлы на маленькие кусочки. Кусочки сохраняются в одну коллекцию (fs.chunks), а метаданные о файле в другую коллекцию (fs.files). <br/>
Когда вы делаете запрос к файлу, GridFS делает запрос в коллекцию с кусочками и возвращает файл целиком.
- files — коллекция, в которой находятся сведения о файлах. Это их имена и метаданные, содержащие информацию об объеме и других параметрах;
- chunks — коллекция, где хранятся сами файлы, но не целиком, а разбитые на небольшие сегменты. Размер каждого сегмента обычно 256 Кб, но эта цифра может меняться.

# Репликация
Для обеспечения отказоустойчивости БД будет развернута на кластере из двух нод и арбитра. Также 1 раз в день, в тех. окно системы будет сниматься полный дамп БД.


